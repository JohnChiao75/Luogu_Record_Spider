<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="global-close-btn" class="close-btn" onclick="closeApp()">Ã—</div>

    <div id="login-container">
        <div class="card" id="login-card">
            <h2>ç”¨æˆ·ç™»å½•</h2>
            <div id="login-form">
                <input type="text" id="username" placeholder="ç”¨æˆ·å">
                <input type="password" id="password" placeholder="å¯†ç ">
                <button id="login-btn" onclick="submitLogin()">ç™» å½•</button>
                <div id="message" style="color:red; margin-top:10px; font-size:12px;"></div>
            </div>
            <div id="loading-overlay" class="hidden" style="margin-top:20px;">
                <div style="color: #666;">æ­£åœ¨è¿æ¥ç³»ç»Ÿ...</div>
            </div>
        </div>
    </div>

    <div id="main-interface">
        <div class="navbar">
            <div class="logo">Luogu Monitor Pro</div>
            <div class="user-profile" onclick="toggleDropdown()">
                <span class="user-name" id="display-username">User</span>
                <div class="avatar" id="display-avatar">U</div>
                <div class="dropdown-menu" id="user-menu">
                    <div class="dropdown-item" onclick="handleLogout(event)">é€€å‡ºç™»å½•</div>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="dashboard-card">
                <h3>ç›‘æ§æ§åˆ¶å°</h3>
                <p>å½“å‰çŠ¶æ€ï¼š<span style="color: #53c41a; font-weight: bold;">è¿è¡Œä¸­</span></p>
                <p style="font-size: 13px; color: #666;">åå°è‡ªåŠ¨æŠ“å–ä¸­ã€‚æ–°æäº¤å°†è§¦å‘åŒé‡å¼¹çª—æé†’ã€‚</p>
                <div style="margin-top: 15px;">
                    <button class="action-btn" onclick="openConfigModal()">ğŸ“‹ ç®¡ç†ç›‘æ§åå•</button>
                </div>
            </div>

            <div class="dashboard-card leaderboard-section" style="margin-top: 20px;">
                <h3>æäº¤æ’è¡Œæ¦œ</h3>
                
                <div class="filter-bar">
                    <div class="filter-item">
                        <label>è¿‘</label>
                        <input type="number" id="filter-days" value="7" min="1" max="60" style="width: 50px;">
                        <label>å¤©</label>
                    </div>
                    <div class="filter-item">
                        <label>éš¾åº¦èŒƒå›´ï¼š</label>
                        <select id="filter-min-lv">
                            <option value="0">å…¥é—¨</option>
                            <option value="1">æ™®åŠâˆ’</option>
                            <option value="2">æ™®åŠ/æé«˜âˆ’</option>
                            <option value="3">æ™®åŠ+/æé«˜</option>
                            <option value="4">æé«˜+/çœé€‰</option>
                            <option value="5">çœé€‰/NOIâˆ’</option>
                            <option value="6">NOI/CTSC</option>
                        </select>
                        <span>è‡³</span>
                        <select id="filter-max-lv">
                            <option value="0">å…¥é—¨</option>
                            <option value="1">æ™®åŠâˆ’</option>
                            <option value="2">æ™®åŠ/æé«˜âˆ’</option>
                            <option value="3">æ™®åŠ+/æé«˜</option>
                            <option value="4">æé«˜+/çœé€‰</option>
                            <option value="5">çœé€‰/NOIâˆ’</option>
                            <option value="6" selected>NOI/CTSC</option>
                        </select>
                    </div>
                    <button class="search-btn" onclick="loadLeaderboard()">æŸ¥è¯¢</button>
                </div>

                <div class="table-container">
                    <table id="leaderboard-table">
                        <thead>
                            <tr>
                                <th width="60">æ’å</th>
                                <th>ç”¨æˆ·</th>
                                <th width="100">é€šè¿‡æ•°</th>
                                <th width="80">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" style="text-align:center; color:#999;">ç‚¹å‡»æŸ¥è¯¢åŠ è½½æ•°æ®</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="config-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-header">
                <h3>ç›‘æ§åå•ç®¡ç†</h3>
                <span class="close-icon" onclick="closeConfigModal()">Ã—</span>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <input type="text" id="new-uid-input" placeholder="è¾“å…¥ç”¨æˆ· ID (å¦‚ 102468)">
                    <button class="add-btn" onclick="addUidItem()">æ·»åŠ </button>
                </div>
                <div class="uid-list-container">
                    <p style="font-size: 12px; color: #666; margin-bottom: 5px;">å½“å‰ç›‘æ§çš„ç”¨æˆ·åˆ—è¡¨ï¼š</p>
                    <div id="uid-tags-area" class="tags-area"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeConfigModal()">å–æ¶ˆ</button>
                <button class="save-btn" onclick="saveConfig()">ä¿å­˜å¹¶é‡å¯ç›‘æ§</button>
            </div>
        </div>
    </div>

    <div id="user-detail-modal" class="modal-overlay hidden">
        <div class="modal-card" style="width: 600px;">
            <div class="modal-header">
                <h3>ç”¨æˆ·æäº¤è®°å½•: <span id="detail-username"></span></h3>
                <span class="close-icon" onclick="closeUserDetailModal()">Ã—</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="record-list-header">
                    <span style="flex:1">æ—¶é—´</span>
                    <span style="flex:2">é¢˜ç›®</span>
                    <span style="flex:1; text-align:right;">éš¾åº¦</span>
                </div>
                <div id="user-record-list" class="record-list-container">
                    </div>
                <div class="pagination-bar">
                    <button id="prev-page-btn" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
                    <span id="page-info">ç¬¬ 1 é¡µ</span>
                    <button id="next-page-btn" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <script>
        // --- å…¨å±€å˜é‡ ---
        let currentMonitorList = []; // å­˜å‚¨ {id, name} å¯¹è±¡
        let currentDetailUid = null;
        let currentDetailPage = 1;
        
        // --- åˆå§‹åŒ– ---
        function waitForPywebview() {
            if (window.pywebview) {
                initCheck();
            } else {
                setTimeout(waitForPywebview, 100);
            }
        }
        async function initCheck() {
            try {
                const res = await pywebview.api.init_check();
                if (res.status === 'success') showWelcome(res.username);
                else document.getElementById('loading-overlay').classList.add('hidden');
            } catch (e) {}
        }

        // --- ç™»å½• ---
        async function submitLogin() {
            const userIn = document.getElementById('username').value;
            const passIn = document.getElementById('password').value;
            const btn = document.getElementById('login-btn');
            const overlay = document.getElementById('loading-overlay');
            
            if(!userIn || !passIn) return alert("è¯·è¾“å…¥è´¦å·å¯†ç ");
            
            btn.disabled = true; overlay.classList.remove('hidden');
            try {
                const res = await pywebview.api.attempt_login(userIn, passIn);
                if (res.status === 'success') showWelcome(res.username);
                else { alert(res.message); btn.disabled = false; overlay.classList.add('hidden'); }
            } catch (e) { alert(e); btn.disabled = false; overlay.classList.add('hidden'); }
        }

        function showWelcome(username) {
            pywebview.api.start_monitoring(username);
            document.getElementById('display-username').innerText = username;
            document.getElementById('display-avatar').innerText = username.charAt(0).toUpperCase();
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('login-container').style.display = 'none';
            const main = document.getElementById('main-interface');
            main.style.opacity = '1'; main.style.pointerEvents = 'auto';
            
            // è‡ªåŠ¨åŠ è½½ä¸€æ¬¡æ’è¡Œæ¦œ
            loadLeaderboard();
        }

        // ==========================================
        // --- æ’è¡Œæ¦œåŠŸèƒ½ ---
        // ==========================================
        async function loadLeaderboard() {
            const days = document.getElementById('filter-days').value;
            const minLv = document.getElementById('filter-min-lv').value;
            const maxLv = document.getElementById('filter-max-lv').value;
            const tbody = document.querySelector('#leaderboard-table tbody');
            
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const res = await pywebview.api.get_leaderboard_data(days, minLv, maxLv);
                if(res.status === 'success') {
                    renderLeaderboard(res.data);
                } else {
                    alert(res.message);
                }
            } catch(e) { alert("æŸ¥è¯¢å¤±è´¥: " + e); }
        }

        function renderLeaderboard(data) {
            const tbody = document.querySelector('#leaderboard-table tbody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">è¯¥èŒƒå›´å†…æ— æäº¤è®°å½•</td></tr>';
                return;
            }

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                // å‰ä¸‰ååŠ å›¾æ ‡
                let rankStr = index + 1;
                if(index === 0) rankStr = 'ğŸ¥‡ 1';
                if(index === 1) rankStr = 'ğŸ¥ˆ 2';
                if(index === 2) rankStr = 'ğŸ¥‰ 3';

                tr.innerHTML = `
                    <td style="text-align:center; font-weight:bold;">${rankStr}</td>
                    <td>${item.user_name} <span style="font-size:12px; color:#999;">(${item.user_id})</span></td>
                    <td style="text-align:center; color:#53c41a; font-weight:bold;">${item.count}</td>
                    <td style="text-align:center;">
                        <button class="small-btn" onclick="openUserDetail('${item.user_id}')">è¯¦æƒ…</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ==========================================
        // --- ç”¨æˆ·è¯¦æƒ… & åˆ†é¡µ ---
        // ==========================================
        function openUserDetail(uid) {
            currentDetailUid = uid;
            currentDetailPage = 1;
            document.getElementById('user-detail-modal').classList.remove('hidden');
            loadUserPage();
        }

        async function loadUserPage() {
            const container = document.getElementById('user-record-list');
            container.innerHTML = '<div style="padding:20px; text-align:center;">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await pywebview.api.get_user_records_page(currentDetailUid, currentDetailPage);
                if(res.status === 'success') {
                    document.getElementById('detail-username').innerText = res.user_name;
                    renderRecordList(res.data);
                    updatePagination(res.total);
                } else {
                    container.innerHTML = `<div style="color:red; text-align:center;">${res.message}</div>`;
                }
            } catch(e) { alert("è·å–è¯¦æƒ…å¤±è´¥: " + e); }
        }

        function renderRecordList(records) {
            const container = document.getElementById('user-record-list');
            container.innerHTML = '';
            
            if(records.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">æœ¬é¡µæ— æ•°æ®</div>';
                return;
            }

            records.forEach(r => {
                const row = document.createElement('div');
                row.className = 'record-row';
                // ä½¿ç”¨åç«¯ä¼ å›çš„ color
                row.innerHTML = `
                    <span style="flex:1; font-size:13px; color:#666;">${r.post_date}</span>
                    <span style="flex:2; font-weight:500;">${r.problem_name} <span style="font-size:12px;color:#999;">(${r.problem_number})</span></span>
                    <span style="flex:1; text-align:right;">
                        <span class="diff-tag" style="background-color:${r.color}">${r.difficulty}</span>
                    </span>
                `;
                container.appendChild(row);
            });
        }

        function updatePagination(total) {
            const pageSize = 10;
            const totalPages = Math.ceil(total / pageSize) || 1;
            document.getElementById('page-info').innerText = `ç¬¬ ${currentDetailPage} / ${totalPages} é¡µ (å…± ${total} æ¡)`;
            document.getElementById('prev-page-btn').disabled = (currentDetailPage <= 1);
            document.getElementById('next-page-btn').disabled = (currentDetailPage >= totalPages);
        }

        function changePage(delta) {
            currentDetailPage += delta;
            loadUserPage();
        }

        function closeUserDetailModal() {
            document.getElementById('user-detail-modal').classList.add('hidden');
        }

        // ==========================================
        // --- ç›‘æ§é…ç½® (ç”¨æˆ·å: ç¼–å·) ---
        // ==========================================
        async function openConfigModal() {
            document.getElementById('config-modal').classList.remove('hidden');
            document.getElementById('uid-tags-area').innerHTML = 'åŠ è½½ä¸­...';
            try {
                const res = await pywebview.api.get_monitor_config();
                if(res.status === 'success') {
                    currentMonitorList = res.data; // [{id: "1", name: "xx"}, ...]
                    renderConfigTags();
                }
            } catch(e) { alert(e); }
        }

        function renderConfigTags() {
            const container = document.getElementById('uid-tags-area');
            container.innerHTML = '';
            if(!currentMonitorList.length) {
                container.innerHTML = '<span style="color:#999;">æš‚æ— </span>'; return;
            }
            currentMonitorList.forEach((item, idx) => {
                const tag = document.createElement('div');
                tag.className = 'uid-tag';
                // æ˜¾ç¤ºï¼šç”¨æˆ·å: ID
                tag.innerHTML = `${item.name}: ${item.id} <span onclick="removeMonitorItem(${idx})">Ã—</span>`;
                container.appendChild(tag);
            });
        }

        function addUidItem() {
            const val = document.getElementById('new-uid-input').value.trim();
            if(!val) return;
            // æŸ¥é‡
            if(currentMonitorList.some(i => i.id === val)) return alert("å·²å­˜åœ¨");
            
            // æš‚æ—¶æ·»åŠ  IDï¼Œåå­—è®¾ä¸º"å¾…è·å–" (åªæœ‰ä¿å­˜é‡å¯çˆ¬è™«åæ‰èƒ½è·å–çœŸå)
            currentMonitorList.push({id: val, name: "æ–°å¢"});
            renderConfigTags();
            document.getElementById('new-uid-input').value = '';
        }

        function removeMonitorItem(idx) {
            currentMonitorList.splice(idx, 1);
            renderConfigTags();
        }

        async function saveConfig() {
            const btn = document.querySelector('#config-modal .save-btn');
            btn.innerText = "ä¿å­˜ä¸­..."; btn.disabled = true;
            // åªæå– ID å‘é€ç»™åç«¯
            const idsOnly = currentMonitorList.map(item => item.id);
            try {
                const res = await pywebview.api.save_monitor_config(idsOnly);
                if(res.status === 'success') {
                    alert("ä¿å­˜æˆåŠŸï¼Œç›‘æ§å·²é‡å¯");
                    closeConfigModal();
                } else alert(res.message);
            } catch(e) { alert(e); }
            btn.innerText = "ä¿å­˜å¹¶é‡å¯ç›‘æ§"; btn.disabled = false;
        }
        function closeConfigModal() { document.getElementById('config-modal').classList.add('hidden'); }

        // --- åº”ç”¨å†…é€šçŸ¥ (è¢«åŠ¨æ¥æ”¶) ---
        function createNotificationCard(data) {
            const container = document.getElementById('notification-container');
            const card = document.createElement('div');
            card.className = 'notify-card';
            card.style.borderLeft = `5px solid ${data.color}`;
            card.innerHTML = `
                <div class="notify-header"><span class="notify-user">${data.user_name}</span><span class="notify-time">${data.time_str}</span></div>
                <div class="notify-body">æäº¤äº† <b>${data.problem_number}</b><div class="notify-pname">${data.problem_name}</div></div>
                <div class="notify-footer"><span class="difficulty-badge" style="background:${data.color}">${data.difficulty}</span></div>
                <div class="notify-close" onclick="this.parentElement.remove()">Ã—</div>`;
            container.appendChild(card);
            setTimeout(() => { card.classList.add('fade-out'); setTimeout(()=>card.remove(),500); }, 8000);
        }

        // --- é€šç”¨ ---
        function toggleDropdown() { document.getElementById('user-menu').classList.toggle('active'); }
        window.onclick = e => { if(!e.target.closest('.user-profile')) document.getElementById('user-menu').classList.remove('active'); }
        async function handleLogout(e) { e.stopPropagation(); await pywebview.api.logout(); location.reload(); }
        function closeApp() { pywebview.api.close_app(); }

        waitForPywebview();
    </script>
</body>
</html>
